<?php
	session_start(['cookie_lifetime' => 604800, 'cookie_samesite' => 'Strict', 'cookie_secure' => true, 'cookie_httponly' => true]);
	require __DIR__.'/../db/config.php';
	require __DIR__.'/user_utilities.php';
	
	$user = new User();
	$action = cleanInput($_POST['action']);
	
	$post_email = cleanInput($_POST['email']);
	$post_firstname = cleanInput($_POST['firstname']);
	$post_lastname = cleanInput($_POST['lastname']);
	$post_password = cleanInput($_POST['password']);
	
	function login(string $username, string $password){
		global $user;
		session_regenerate_id(True);
		if ($user->login($username, $password)){
			// Login successful.
			$_SESSION['email'] = $user->getEmail();
			redirectHome();
		}
		error();
	}
	
	// https://www.getastra.com/blog/php-security/php-security-guide/
	
	// SOURCE: https://stackoverflow.com/questions/1205889/how-to-prevent-code-injection-attacks-in-php
	// https://snyk.io/blog/prevent-php-code-injection/
	if (!empty($action)) {
		if ($action == "signup"){
			$id = $user->getIdFromEmail($post_email);
			if (is_null($id)){
				$id = $user->createUser($post_firstname, $post_lastname, $post_email, $post_password);
				if (!is_null($id)){
					// User registered.
					login($post_email, $post_password);
				}
			}
		} else if ($action == "login"){
			login($post_email, $post_password);
		}
	}
	error();
?>
